<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>The JavaScript Runtime, Fibers, and Meteor.wrapAsync (Meteor.js)</title>
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://smashingthingstogether.com/css/main.css">
</head>
<body class="is-page">
  <div class="site-wrapper container">
    <div class="main-header show-if-is-page">
      <h1 class="page-title center"><a href="http://smashingthingstogether.com/"><img class="site-logo" alt="The JavaScript Runtime, Fibers, and Meteor.wrapAsync (Meteor.js) Logo" src="http://smashingthingstogether.com/svgs/logo.svg" /></a></h1>
    </div>
    <div class="main-header hide-if-is-page">
      <h1 class="page-title"><a href="http://smashingthingstogether.com/">Smashing Things Together<img class="site-logo" alt="The JavaScript Runtime, Fibers, and Meteor.wrapAsync (Meteor.js) Logo" src="http://smashingthingstogether.com/svgs/logo.svg" /></a></h1>
      <h2 class="page-description">Experiments, projects, and random ideas</h2>
    </div>
<main class="content" role="main">
  <article class="post mb8">
    <header class="post-header">
      <h1 class="post-title">The JavaScript Runtime, Fibers, and Meteor.wrapAsync (Meteor.js)</h1>
      <div class="mb3 extra-post-info">
        <time class="post-date" datetime="2015-06-27">posted Sat, Jun 27, 2015</time> &middot; <a class="comment-link" href="http://smashingthingstogether.com/post/the-javascript-runtime-fibers-and-meteor-wrapasync/#disqus_thread" data-disqus-identifier="5">Comments</a>
      </div>
    </header>
    <section class="post-content">
      

<h2 id="part-1:0a937069e89d2f82c268b50205f4fb17">Part 1:</h2>

<h3 id="the-call-stack-the-event-loop-the-task-queue-and-how-asyncronous-functions-work-br-br:0a937069e89d2f82c268b50205f4fb17">The call stack, the event loop, the task queue, and how asyncronous functions work<br><br></h3>

<p>First, some basic context. When you run some JavaScript code, it&rsquo;s added to the <strong>task queue</strong>. Think of this as a todo list.</p>

<p>When we reach the first item on the todo list, we move it over to another todo list called the <strong>call stack</strong>. Think of this as a todo list that you want to complete before moving on to the rest of the stuff in your main todo list. The reason you do this is because things in this todo list (the <strong>call stack</strong>) might expand into more than one thing.</p>

<p>Have you seen <a href="http://www.adultswim.com/videos/rick-and-morty/">Rick and Morty</a>? No..? Well, there are magical creatures on that show called Meeseeks. The way they work is you press a button and a Meeseeks pops out. Its one goal in life is to accomplish a single task, whatever you want, and then disappear forever. When it gets really frustrated though, it might choose to press the button again itself and out will pop another Meeseeks, who will also try to accomplish the original goal.</p>

<p><img src="https://s3.amazonaws.com/webnet/smashing-things/post-call-stack/meeseeks.gif" alt="Meeseeks" /></p>

<p>When a function in your code calls another function, think of this as a Meeseeks pressing the button and summoning another Meeseeks to help him accomplish the original function&rsquo;s goal. This can get pretty deep pretty fast, with one function that calls another function that calls another function. You can end up with hundreds of Meeseeks, I mean functions, which were all called by one original function.</p>

<p>Let me give you an example of this.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">function</span> <span style="color: #a6e22e">doLaundry</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">quarters</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">getQuarters</span><span style="color: #f8f8f2">();</span>

  <span style="color: #75715e">// gatherClothes();</span>
  <span style="color: #75715e">// goToLaundromat();</span>
  <span style="color: #75715e">// putQuartersInMachine();</span>
  <span style="color: #75715e">// etc.</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getQuarters</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">quarters</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">getQuartersFromCoinJar</span><span style="color: #f8f8f2">();</span>

  <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">quarters</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">33</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">quarters</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">getQuartersFromBank</span><span style="color: #f8f8f2">();</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getQuartersFromCoinJar</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">4</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getQuartersFromBank</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">walkToBank</span><span style="color: #f8f8f2">();</span>

  <span style="color: #75715e">// ...</span>
  <span style="color: #75715e">// etc.</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">walkToBank</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// ...</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #a6e22e">doLaundry</span><span style="color: #f8f8f2">();</span>
</pre></div>


<p><strong>Note:</strong> You can access all of the code mentioned in this article here: <a href="https://github.com/panphora/meteorMeetup">June 2015 Meteor Meetup</a></p>

<p>In the code above, we call <code>doLaundry()</code>, which in turn calls <code>getQuarters()</code>, which in turn calls <code>getQuartersFromBank()</code>, which finally calls <code>walkToBank()</code>.</p>

<p>This could go on and on.</p>

<p>If you run this code on the server in a meteor app, using <code>meteor debug</code> instead of the standard <code>meteor</code> command &mdash; and put a <code>debugger;</code> statement in the <code>walkToBank()</code> function, you can see the <strong>call stack</strong> in your developer tools.</p>

<p>Add the <code>debugger</code> statement:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">function</span> <span style="color: #a6e22e">walkToBank</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">debugger</span><span style="color: #f8f8f2">;</span>
  <span style="color: #75715e">// ...</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Run meteor in debug mode:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>cd /repoDirectory
meteor debug
</pre></div>


<p>Go to the url it prints out:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>To debug the server process using a graphical debugging interface, visit this URL in your web browser:
http://localhost:8080/debug?port=5858
</pre></div>


<p>Here&rsquo;s what the <strong>call stack</strong> will look like (look at the right sidebar after loading up that url):</p>

<p><img src="https://s3.amazonaws.com/webnet/smashing-things/post-call-stack/call-stack-screenshot.png" alt="call stack" /></p>

<p>The function at the top of the <strong>call stack</strong>, <code>walkToBank</code>, is the one we&rsquo;re currently processing. After that&rsquo;s finished, we&rsquo;ll return to the previous function and finish it up before moving on.</p>

<p>So&hellip; as you can see, we can end up doing a lot of things that we weren&rsquo;t intending to do in the first place, like going to the bank when all we wanted to do was do laundry.</p>

<p>Now, this can cause some issues for our main todo list (the <strong>task queue</strong>). Let&rsquo;s pretend we need to not only get laundry done today, but also go shopping and go to a Meteor Meetup. If we spend all our time doing laundry, we won&rsquo;t have time for other things.</p>

<p>This is why we use asynchronous functions. Asynchronous functions allow us to pass off tasks to another server or database or to the file system &mdash; and get the results whenever they&rsquo;re handed back to us. This way, if we want to resize an image and add a watermark to it, for example, we can upload it to an external service and wait for the response while the rest of our program does something else.</p>

<p>Let me give you an example of an asynchronous function in code.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">function</span> <span style="color: #a6e22e">doLaundryWithWashio</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// &quot;Washio&quot; is a service that does laundry for you</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">clothes</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">gatherClothes</span><span style="color: #f8f8f2">();</span>

  <span style="color: #a6e22e">scheduleWashio</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;12pm&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #75715e">// Washio arrives for initial pick-up</span>
    <span style="color: #a6e22e">giveWashioClothes</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #75715e">// Washio arrives to drop off clothes</span>
      <span style="color: #a6e22e">getCleanClothes</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">});</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">gatherClothes</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;shirt&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;pants&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;socks&#39;</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">scheduleWashio</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">time</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback when Washio arrives at house</span>
  <span style="color: #75715e">// 5 seconds here for demonstration purposes</span>
  
  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;confirmed&#39;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">5000</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">giveWashioClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback after clothes are cleaned</span>
  <span style="color: #75715e">// 5 seconds here for demonstration purposes</span>

  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">item</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;clean &#39;</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">item</span><span style="color: #f8f8f2">}));</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">5000</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getCleanClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;clean clothes: &#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">join</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;, &#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #a6e22e">doLaundryWithWashio</span><span style="color: #f8f8f2">();</span>

<span style="color: #75715e">// a lot could happen here while the above asynchronous function is running, but we&#39;re just printing a message</span>
<span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;do something else&#39;</span><span style="color: #f8f8f2">);</span> 
</pre></div>


<p>As you can see, we have some callbacks that take some time to return. The callback function <code>scheduleWashio</code>, for example, won&rsquo;t return for 5 seconds. This will give us time to do other things and won&rsquo;t block the rest of our code.</p>

<p>When the <strong>call stack</strong> is clear, for example after some asynchronous code is called that won&rsquo;t return for a while, the JavaScript runtime will take the next thing off the <strong>task queue</strong> and add it to the <strong>call stack</strong>. This code, in turn, can call other functions that will also be added to the <strong>call stack</strong>. And the JavaScript runtime won&rsquo;t be able to do anything else until all of this code is done running.</p>

<p>This is why, when you write blocking code, like a <code>for</code> loop (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for">for loop docs</a>) that iterates over 10,000 items, it can lock up the page. The JavaScript runtime isn&rsquo;t able to update the page or even handle events until the call stack is clear.</p>

<h2 id="part-2:0a937069e89d2f82c268b50205f4fb17">Part 2:</h2>

<h3 id="a-simple-example-of-using-fibers-br-br:0a937069e89d2f82c268b50205f4fb17">A simple example of using fibers<br><br></h3>

<p>You may have noticed that the asynchronous code in the last section got a little unwieldy. You can get very used to thinking linearly, so when you have to write code that will be run &ldquo;some time in the future&rdquo; your abstractions can break down. We can also end up with a lot of nested callbacks, which makes it a little harder to think about what our code is actually going to do.</p>

<p>This is where fibers come in. (<a href="https://github.com/laverdet/node-fibers">node-fibers docs</a>)</p>

<p>Fibers make asynchronous code look and behave like synchronous code. They simultaneously allow us to avoid callbacks while also not blocking the execution of the rest of our code.</p>

<p>Here&rsquo;s an example of a fiber, using our previous code as a template. Run it using <code>meteor debug</code> if you want to observe the call stack at different points.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">Fiber</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Npm</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;fibers&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">doLaundryWithWashio</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Doing laundry&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">clothes</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">gatherClothes</span><span style="color: #f8f8f2">();</span>

  <span style="color: #66d9ef">debugger</span><span style="color: #f8f8f2">;</span> <span style="color: #75715e">//look at the call stack here</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">isConfirmed</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">scheduleWashio</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;12pm&#39;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Washio is: &#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">isConfirmed</span> <span style="color: #f92672">?</span> <span style="color: #e6db74">&#39;confirmed&#39;</span> <span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;not confirmed&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">debugger</span><span style="color: #f8f8f2">;</span> <span style="color: #75715e">//look at the terminal... the for loop at the bottom of this code should have completed before the &quot;Washio is: confirmed&quot; string gets printed out</span>

  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cleanClothes</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">giveWashioClothes</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">);</span>

  <span style="color: #a6e22e">getCleanClothes</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">gatherClothes</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;shirt&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;pants&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;socks&#39;</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">scheduleWashio</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">time</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback when Washio arrives at house</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Scheduling Washio&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">fiber</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">current</span><span style="color: #f8f8f2">;</span>
  
  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">fiber</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">true</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">3000</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">.</span><span style="color: #66d9ef">yield</span><span style="color: #f8f8f2">();</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">giveWashioClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback after clothes are cleaned</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Giving Washio some clothes&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">fiber</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">current</span><span style="color: #f8f8f2">;</span>
  
  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">fiber</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">item</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span><span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;clean &#39;</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">item</span><span style="color: #f8f8f2">}));</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">3000</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">.</span><span style="color: #66d9ef">yield</span><span style="color: #f8f8f2">();</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getCleanClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;clean clothes: &#39;</span> <span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">join</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;, &#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>


<span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">doLaundryWithWashio</span><span style="color: #f8f8f2">();</span>
<span style="color: #f8f8f2">}).</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">();</span>

<span style="color: #75715e">// yields to this</span>
<span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span> <span style="color: #f92672">===</span> <span style="color: #ae81ff">9999</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;for loop complete!&#39;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}).</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">();</span>
</pre></div>
</p>

<p>As you can see, this can get a bit complicated. Luckily, most Meteor server code runs in fibers automatically, so it takes care of the heavy lifting &mdash; like the code at the bottom of the snippet above that creates and runs the fibers. If you&rsquo;ve ever wondered why you can return a result from the database in Meteor without using a callback, it&rsquo;s because all of the Meteor database functions use Fibers under the hood.</p>

<p>In the code above, we&rsquo;re running the <code>doLaundryWithWashio()</code> function in a fiber. We&rsquo;re also running a <code>for</code> loop in another fiber right underneath it.</p>

<p>In the main <code>doLaundryWithWashio</code> function you&rsquo;ll notice we&rsquo;re treating our asynchronous functions (<code>scheduleWashio</code> and <code>giveWashioClothes</code>) like synchronous function and using the results we get back from them right away in the next computation. The magic of fibers happens inside of these functions.</p>

<p>First, we get the current fiber using <code>var fiber = Fiber.current;</code>. Then, at the end of the function, we call <code>Fiber.yield()</code>. Think of this <code>yield</code> method like you&rsquo;re pressing the pause button while playing a video game so you can go off and do something else.</p>

<p>When you come back to your video game later, you can start where you left off. This is what the <code>fiber.run()</code> function does inside of the asynchronous <code>setTimeout</code> function. It starts the fiber that we paused and adds it to the <strong>task queue</strong>. This means that after we call <code>giveWashioClothes()</code> (i.e. our first async function), the <code>for</code> loop in the next fiber has time to run. After that&rsquo;s complete, we wait a little and then the fiber will resume and continue running.</p>

<p>There are a couple of good reasons you might want to know about all of this stuff. One reason is that you can get a very annoying error sometimes if you work with a lot of server code. It says something like, &ldquo;Meteor code must always run within a Fiber.&rdquo; You could build lots of stuff in Meteor without knowing what this error means, but I think it&rsquo;s fun and useful to actually know.</p>

<p>The second reason you might want to know about fibers is because there&rsquo;s a massive ecosystem of <a href="https://www.npmjs.com/#explicit">npm modules</a>, specifically built for Node.js, a lot of which use asynchronous callbacks &ndash; and, because these modules are not normally compatible with running inside of fibers, you can&rsquo;t use them without modifying them a little bit to work with Meteor.</p>

<h2 id="part-3:0a937069e89d2f82c268b50205f4fb17">Part 3</h2>

<h3 id="a-simple-example-of-using-meteor-wrapasync:0a937069e89d2f82c268b50205f4fb17">A simple example of using Meteor.wrapAsync()</h3>

<p>There&rsquo;s an excellect blog post by the Discover Meteor team called <a href="https://www.discovermeteor.com/blog/wrapping-npm-packages/">&ldquo;Wrapping NPM Packages for Meteor&rdquo;</a>. I highly recommend you check it out. I was originally going to write this blog post on how to wrap the <a href="https://github.com/1lobby/mailgun-js">Mailgun NPM module</a> for Meteor, because I needed to be able to send attachments in my application and Meteor&rsquo;s <code>Email</code> functionality (<a href="http://docs.meteor.com/#/full/email">Email docs</a>) doesn&rsquo;t support this (even though it will in <a href="https://github.com/meteor/meteor/blob/devel/History.md#in-progress-v111">version 1.1.1</a>). But they cover most of how to do that in the Discover Meteor post, so I decided to talk more about the lower level stuff here.</p>

<p>To wrap up, I want to show you a Meteor method that makes working with asynchronous code easier. Not only does it use fibers under the hood, but it also binds the Meteor environment to that function, so you can access things like the <code>Meteor</code> object and built-ins like <code>this.Blaze</code> and <code>this.Deps</code>.</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">Fiber</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Npm</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;fibers&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">scheduleWashioSync</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Meteor</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">wrapAsync</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">scheduleWashio</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">giveWashioClothesSync</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">Meteor</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">wrapAsync</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">giveWashioClothes</span><span style="color: #f8f8f2">);</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">doLaundryWithWashio</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Doing laundry&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">clothes</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">gatherClothes</span><span style="color: #f8f8f2">();</span>

  <span style="color: #75715e">// async</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">isConfirmed</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">scheduleWashioSync</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;12pm&#39;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Washio is: &#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">isConfirmed</span> <span style="color: #f92672">?</span> <span style="color: #e6db74">&#39;confirmed&#39;</span> <span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;not confirmed&#39;</span><span style="color: #f8f8f2">);</span>
  
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cleanClothes</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">giveWashioClothesSync</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">);</span>

  <span style="color: #a6e22e">getCleanClothes</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">gatherClothes</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;shirt&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;pants&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;socks&#39;</span><span style="color: #f8f8f2">];</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">scheduleWashio</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">time</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback when Washio arrives at house</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Scheduling Washio&#39;</span><span style="color: #f8f8f2">);</span>
  
  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">true</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">3000</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">giveWashioClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #75715e">// call callback after clothes are cleaned</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Giving Washio some clothes&#39;</span><span style="color: #f8f8f2">);</span>
  
  <span style="color: #a6e22e">setTimeout</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">callback</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">null</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">clothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">map</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">item</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span><span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;clean &#39;</span> <span style="color: #f92672">+</span> <span style="color: #a6e22e">item</span><span style="color: #f8f8f2">}));</span>
  <span style="color: #f8f8f2">},</span> <span style="color: #ae81ff">3000</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">getCleanClothes</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;clean clothes: &#39;</span> <span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">cleanClothes</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">join</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;, &#39;</span><span style="color: #f8f8f2">));</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">doLaundryWithWashio</span><span style="color: #f8f8f2">();</span>
<span style="color: #f8f8f2">}).</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">();</span>

<span style="color: #75715e">// yields to this</span>
<span style="color: #a6e22e">Fiber</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">i</span> <span style="color: #f92672">===</span> <span style="color: #ae81ff">9999</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;for loop complete!&#39;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}).</span><span style="color: #a6e22e">run</span><span style="color: #f8f8f2">();</span>
</pre></div>
</p>

<p>This code is remarkably similar to our initial fibers example. The only difference is we simplify our asynchronous functions by wrapping them with <code>Meteor.wrapAsync</code>. We don&rsquo;t have to do anything else except wrap it, which makes it perfect for working with code you don&rsquo;t want to modify.</p>

<p>Two things to keep in mind when using <code>Meteor.wrapAsync</code>: it expects the callback function that&rsquo;s called inside your asynchronous function to be the last argument and it expects the callback&rsquo;s first parameter to be an error or <code>null</code> value (if there is no error). This is standard practice and you&rsquo;ll find that most NPM modules do this already.</p>

<p>So, now you know &mdash; if you want to include an external, asyncronous module in Meteor (and be able to use it like it&rsquo;s running syncronously), you should use <code>Meteor.wrapAsync</code>!</p>

<p>And now you also know why!</p>

<h2 id="this-code-is-on-github:0a937069e89d2f82c268b50205f4fb17">This code is on GitHub</h2>

<p>You can access all of the code mentioned in this article here: <a href="https://github.com/panphora/meteorMeetup">June 2015 Meteor Meetup</a></p>

<h2 id="questions:0a937069e89d2f82c268b50205f4fb17">Questions?</h2>

<p>If you have any questions, you can leave a comment here, contact me on twitter at <a href="https://twitter.com/artisfyhq">artisfyhq</a>, or email me at <a href="mailto:david@storylog.com">david@storylog.com</a>.</p>

<h2 id="additional-resources:0a937069e89d2f82c268b50205f4fb17">Additional resources</h2>

<p>If you want an alternate explanation of these topics, with extra-cute explanatory comics, check out this awesome article: <a href="http://phucnguyen.info/blog/everything-you-need-to-know-about-async-meteor/">Everything You Need To Know About Async &amp; Meteor</a></p>

<p>Also, for some of the <strong>best</strong> Meteor.js tutorials related to these topics, check out these awesome <a href="https://www.eventedmind.com/">Evented Mind</a> screencasts:</p>

<ul>
<li><a href="https://www.eventedmind.com/classes/the-javascript-runtime/what-is-a-runtime">The JavaScript Runtime</a> &mdash; 7 video series</li>
<li><a href="https://www.eventedmind.com/classes/meteor-fibers-and-dynamics-9ba17f98/introduction-852d7a76">Meteor Fibers and Dynamics</a> &mdash; 8 video series</li>
</ul>

<p>I found these screencasts to be very helpful in furthering my understanding of JavaScript and Meteor.js and I refer back to them sometimes when I need a deeper understanding.</p>

    </section>
  </article>
</main>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'smashingthings';
if (disqus_shortname && disqus_shortname !== 'example') {
  var disqus_identifier = '5';

   
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
}
</script>
    <footer class="site-footer clearfix">
      <section class="poweredby">Proudly published with <a href="http://gohugo.io/">Hugo</a></section>
    </footer>
  </div>
  <script type="text/javascript" src="http://smashingthingstogether.com/js/main.js"></script>
</body>
</html>